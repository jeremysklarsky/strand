<link rel="import" href="../js/rectangle.html">
<link rel="import" href="windownotifier.html">
<link rel="import" href="autoclosable.html">
<script type="text/javascript">
	
(function(scope) {

	var Rectangle = StrandLib.Rectangle;
	var _overlay;

	var Positionable = {

		properties: {
			target: {
				type: Object,
				observer: '_targetChanged'
			},
			state: {
				type: String,
				value: 'closed',
				observer: '_stateChanged'
			},
			offset: {
				type: Number,
				value: 0
			},
			boundaryOffset: {
				type: Number,
				value: 10
			}
		},

		ready: function() {
			this.template = Polymer.dom(this).querySelector('template');
		},

		attached: function() {

			if(!_overlay) {
				_overlay = new this.constructor();
				_overlay.offset = this.offset;
				_overlay.boundaryOffset = this.boundaryOffset;
				document.body.appendChild(_overlay);
			}

			if(this.template) {
				Polymer.dom(_overlay).appendChild(this.template.content);
			}
		},

		resize: function() {
			_overlay.update();
		},
		
		scroll: function() {
			_overlay.update();
		},

		update: function () {
			if(!this.target) return;

			_overlay._updatePosition();
		},

		_updatePosition: function() {},

		get metrics() {
			return Rectangle.fromElement(_overlay);
		},

		get targetMetrics() {
			return this.target && Rectangle.fromElement(this.target);
		},

		get windowMetrics() {
			return new Rectangle(0, 0, document.documentElement.clientWidth, document.documentElement.clientHeight);
		},

		_stateChanged: function(newState, oldState) {
			if(!_overlay) return;
			if (newState === this.STATE_OPENED) {
				// Polymer.dom(_overlay).appendChild(this.getContentChildren());
				_overlay.update();
				_overlay.style.clip = "auto";
			} else {
				_overlay.style.clip = "rect(0,0,0,0)";
			}
		},

		_targetChanged: function(target) {
			_overlay.target = target;
		},

		_computeContainerStyle: function(boundaryOffset) {
			return 'padding: ' + boundaryOffset + 'px';
		}

	};

	scope.Positionable = [
		scope.AutoClosable,
		scope.WindowNotifier,
		Positionable
	];

})(window.StrandTraits = window.StrandTraits || {});
</script>